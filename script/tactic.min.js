function refreshTracking(){tree=new RTree,$(".touchable, .movable, object-aware").each(function(){var e=$(this);tree.insert({x:e.offset().left,y:e.offset().top,w:e.width(),h:e.height()},e)})}function initTracking(e){refreshTracking(),touches={},objects={},table_object_tree=new RTree,tuio.cursor_add(function(e){touches[e.sid]={x:e.x*t,y:e.y*n,divs:[],movables:[]},tree.search({x:e.x*t,y:e.y*n,w:15,h:15}).filter(function(e){return e.hasClass("touchable")}).map(function(i){i.trigger("touch.press",[{x:e.x*t,y:e.y*n,id:e.fid}]),touches[e.sid].divs.push(i)}),tree.search({x:e.x*t,y:e.y*n,w:15,h:15}).filter(function(e){return e.hasClass("movable")}).map(function(i){touches[e.sid].movables.push({div:i,initX:e.x*t-$(i).position().left,initY:e.y*n-$(i).position().top})})}),tuio.cursor_update(function(e){touches[e.sid].x=e.x*t,touches[e.sid].y=e.y*n;var i=[];tree.search({x:e.x*t,y:e.y*n,w:15,h:15}).filter(function(e){return e.hasClass("touchable")}).map(function(s){touches[e.sid].divs.indexOf(s)>=0?s.trigger("touch.update",[{x:e.x*t,y:e.y*n,id:e.fid}]):(s.trigger("touch.press",[{x:e.x*t,y:e.y*n,id:e.fid}]),touches[e.sid].divs.push(s)),i.push(s)}),touches[e.sid].divs.map(function(s){if(-1==i.indexOf(s)){s.trigger("touch.remove",[{id:e.fid,x:e.x*t,y:e.y*n}]);var o=touches[e.sid].divs.indexOf(s);touches[e.sid].divs.splice(o,1)}}),touches[e.sid].movables.map(function(i){var s=e.x*t-i.initX,o=e.y*n-i.initY,r=i.div;$(r).css("left",s),$(r).css("top",o),tree.remove({x:r.offset().left,y:r.offset().top,w:r.width(),h:r.height()},r),tree.insert({x:s,y:o,w:r.width(),h:r.height()},r)})}),tuio.cursor_remove(function(e){touches[e.sid].divs.map(function(i){i.trigger("touch.release",[{x:e.x*t,y:e.y*n,id:e.fid}])}),delete touches[e.sid]}),tuio.object_add(function(e){objects[e.fid]={x:e.x*t,y:e.y*n,angle:e.angle,inside:[]};var i=objects[e.fid];table_object_tree.insert({x:i.x-100,y:i.y-100,w:200,h:200},i),tree.search({x:e.x*t,y:e.y*n,w:15,h:15}).filter(function(e){return e.hasClass("object-aware")}).map(function(i){i.trigger("object.add",[{id:e.fid,x:e.x*t,y:e.y*n,angle:e.angle}]),objects[e.fid].inside.push(i)})}),tuio.object_update(function(e){objects[e.fid].x=e.x*t,objects[e.fid].y=e.y*n;var i=[];tree.search({x:e.x*t,y:e.y*n,w:15,h:15}).filter(function(e){return e.hasClass("object-aware")}).map(function(s){objects[e.fid].inside.indexOf(s)>=0?s.trigger("object.update",[{id:e.fid,x:e.x*t,y:e.y*n,angle:e.angle}]):(s.trigger("object.add",[{id:e.fid,x:e.x*t,y:e.y*n,angle:e.angle}]),objects[e.fid].inside.push(s)),i.push(s)}),objects[e.fid].inside.map(function(s){if(-1==i.indexOf(s)){s.trigger("object.remove",[{id:e.fid,x:e.x*t,y:e.y*n,angle:e.angle}]);var o=objects[e.fid].inside.indexOf(s);objects[e.fid].inside.splice(o,1)}})}),tuio.object_remove(function(e){objects[e.fid].inside.map(function(i){i.trigger("object.release",[{id:e.fid,x:e.x*t,y:e.y*n,angle:e.angle}])}),delete objects[e.fid]}),tuio.start();var t=$(window).width(),n=$(window).height();$("#__tuiojs_connector_npTuioClient").css("visibility","hidden")}function tuio_callback(e,t,n,i,s,o){tuio.callback(e,t,n,i,s,o)}var touches,tree,objects,TUIO=function(){this.Listener=function(e){if(void 0!=e)for(var t in e)this[t]=e[t]},this.Listener.prototype={object_add:function(e){},object_update:function(e){},object_remove:function(e){},cursor_add:function(e){},cursor_update:function(e){},cursor_remove:function(e){}},this.objects=[],this.cursors=[],this._data={},this._default_listener=new this.Listener,this._listeners=[this._default_listener],this._connector=void 0};TUIO.prototype={start:function(e){var t=this._connector;void 0!=t&&void 0!=t.start&&t.start()},stop:function(){var e=this._connector;void 0!=e&&void 0!=e.stop&&e.stop()},setConnector:function(e){this._connector=e},addListener:function(e){this._listeners.push(e)},removeListener:function(e){this._listeners.splice(this._listeners.indexOf(e),1)},_invoke:function(e,t){var n,i=this._listeners.length;for(n=0;i>n;n++){var s=this._listeners[n];s[e](t)}},callback:function(e,t,n,i,s,o){var r;switch(0!=e&&3!=e?r=this._data[t]:(r={sid:t,fid:n,path:[]},this._data[t]=r),r.path.push([i,s]),r.x=i,r.y=s,3>e&&(r.angle=o),e){case 0:this.objects.push(r),this._invoke("object_add",r);break;case 1:this._invoke("object_update",r);break;case 2:this.objects.splice(this.objects.indexOf(r),1),this._invoke("object_remove",r);break;case 3:this.cursors.push(r),this._invoke("cursor_add",r);break;case 4:this._invoke("cursor_update",r);break;case 5:this.cursors.splice(this.cursors.indexOf(r),1),this._invoke("cursor_remove",r)}(2==e||5==e)&&delete this._data[t]},object_add:function(e){this._default_listener.object_add=e},object_update:function(e){this._default_listener.object_update=e},object_remove:function(e){this._default_listener.object_remove=e},cursor_add:function(e){this._default_listener.cursor_add=e},cursor_update:function(e){this._default_listener.cursor_update=e},cursor_remove:function(e){this._default_listener.cursor_remove=e}},function(){var e=function(){this.Listener=function(e){if(void 0!=e)for(var t in e)this[t]=e[t]},this.Listener.prototype={object_add:function(e){},object_update:function(e){},object_remove:function(e){},cursor_add:function(e){},cursor_update:function(e){},cursor_remove:function(e){}},this.objects=[],this.cursors=[],this._data={},this._default_listener=new this.Listener,this._listeners=[this._default_listener],this._connector=void 0};e.prototype={start:function(e){var t=this._connector;void 0!=t&&void 0!=t.start&&t.start()},stop:function(){var e=this._connector;void 0!=e&&void 0!=e.stop&&e.stop()},setConnector:function(e){this._connector=e},addListener:function(e){this._listeners.push(e)},removeListener:function(e){this._listeners.splice(this._listeners.indexOf(e),1)},_invoke:function(e,t){var n,i=this._listeners.length;for(n=0;i>n;n++){var s=this._listeners[n];s[e](t)}},callback:function(e,t,n,i,s,o){var r;switch(0!=e&&3!=e?r=this._data[t]:(r={sid:t,fid:n,path:[]},this._data[t]=r),r.path.push([i,s]),r.x=i,r.y=s,3>e&&(r.angle=o),e){case 0:this.objects.push(r),this._invoke("object_add",r);break;case 1:this._invoke("object_update",r);break;case 2:this.objects.splice(this.objects.indexOf(r),1),this._invoke("object_remove",r);break;case 3:this.cursors.push(r),this._invoke("cursor_add",r);break;case 4:this._invoke("cursor_update",r);break;case 5:this.cursors.splice(this.cursors.indexOf(r),1),this._invoke("cursor_remove",r)}(2==e||5==e)&&delete this._data[t]},object_add:function(e){this._default_listener.object_add=e},object_update:function(e){this._default_listener.object_update=e},object_remove:function(e){this._default_listener.object_remove=e},cursor_add:function(e){this._default_listener.cursor_add=e},cursor_update:function(e){this._default_listener.cursor_update=e},cursor_remove:function(e){this._default_listener.cursor_remove=e}},this.tuio=new e}(),tuio.setConnector({_failmsg:"Unable to initialize npTuioClient plugin.",_id:"__tuiojs_connector_npTuioClient",start:function(){var e=document.getElementById(this._id);if(void 0==e){var e=document.createElement("object");e.setAttribute("id",this._id),e.setAttribute("type","application/x-tuio"),e.appendChild(document.createTextNode(this._failmsg)),document.body.appendChild(e)}},stop:function(){var e=document.getElementById(this._id);void 0!=e&&document.body.removeChild(e)}});var RTree=function(e){var t=3,n=6;isNaN(e)||(t=Math.floor(e/2),n=e);var i={x:0,y:0,w:0,h:0,id:"root",nodes:[]},s=function(e){return"[object Array]"===Object.prototype.toString.call(e)},o=function(){var e={};return function(t){var n=0;return t in e?n=e[t]++:e[t]=0,t+"_"+n}}();RTree.Rectangle.squarified_ratio=function(e,t,n){var i=(e+t)/2,s=e*t,o=s/(i*i);return s*n/o};var r=function(e,n,i){var s=[],o=[],r=[],a=1;if(!e||!RTree.Rectangle.overlap_rectangle(e,i))return r;var h={x:e.x,y:e.y,w:e.w,h:e.h,target:n};o.push(i.nodes.length),s.push(i);do{var c=s.pop(),d=o.pop()-1;if("target"in h)for(;d>=0;){var u=c.nodes[d];if(RTree.Rectangle.overlap_rectangle(h,u)){if(h.target&&"leaf"in u&&u.leaf===h.target||!h.target&&("leaf"in u||RTree.Rectangle.contains_rectangle(u,h))){"nodes"in u?(r=l(u,!0,[],u),c.nodes.splice(d,1)):r=c.nodes.splice(d,1),RTree.Rectangle.make_MBR(c.nodes,c),delete h.target,c.nodes.length<t&&(h.nodes=l(c,!0,[],c));break}"nodes"in u&&(a+=1,o.push(d),s.push(c),c=u,d=u.nodes.length)}d-=1}else if("nodes"in h){c.nodes.splice(d+1,1),c.nodes.length>0&&RTree.Rectangle.make_MBR(c.nodes,c);for(var x=0;x<h.nodes.length;x++)f(h.nodes[x],c);h.nodes.length=0,0==s.length&&c.nodes.length<=1?(h.nodes=l(c,!0,h.nodes,c),c.nodes.length=0,s.push(c),o.push(1)):s.length>0&&c.nodes.length<t?(h.nodes=l(c,!0,h.nodes,c),c.nodes.length=0):delete h.nodes}else RTree.Rectangle.make_MBR(c.nodes,c);a-=1}while(s.length>0);return r},a=function(e,t){var n,i=-1,s=[];s.push(t);var o=t.nodes;do{-1!=i&&(s.push(o[i]),o=o[i].nodes,i=-1);for(var r=o.length-1;r>=0;r--){var a=o[r];if("leaf"in a){i=-1;break}var h=RTree.Rectangle.squarified_ratio(a.w,a.h,a.nodes.length+1),c=Math.max(a.x+a.w,e.x+e.w)-Math.min(a.x,e.x),d=Math.max(a.y+a.h,e.y+e.h)-Math.min(a.y,e.y),u=RTree.Rectangle.squarified_ratio(c,d,a.nodes.length+2);(0>i||Math.abs(u-h)<n)&&(n=Math.abs(u-h),i=r)}}while(-1!=i);return s},h=function(e){for(var t=d(e);e.length>0;)c(e,t[0],t[1]);return t},c=function(e,n,i){for(var s,o,r,a=RTree.Rectangle.squarified_ratio(n.w,n.h,n.nodes.length+1),h=RTree.Rectangle.squarified_ratio(i.w,i.h,i.nodes.length+1),c=e.length-1;c>=0;c--){var d=e[c],u={};u.x=Math.min(n.x,d.x),u.y=Math.min(n.y,d.y),u.w=Math.max(n.x+n.w,d.x+d.w)-u.x,u.h=Math.max(n.y+n.h,d.y+d.h)-u.y;var l=Math.abs(RTree.Rectangle.squarified_ratio(u.w,u.h,n.nodes.length+2)-a),f={};f.x=Math.min(i.x,d.x),f.y=Math.min(i.y,d.y),f.w=Math.max(i.x+i.w,d.x+d.w)-f.x,f.h=Math.max(i.y+i.h,d.y+d.h)-f.y;var x=Math.abs(RTree.Rectangle.squarified_ratio(f.w,f.h,i.nodes.length+2)-h);(!o||!s||Math.abs(x-l)<s)&&(o=c,s=Math.abs(x-l),r=l>x?i:n)}var g=e.splice(o,1)[0];n.nodes.length+e.length+1<=t?(n.nodes.push(g),RTree.Rectangle.expand_rectangle(n,g)):i.nodes.length+e.length+1<=t?(i.nodes.push(g),RTree.Rectangle.expand_rectangle(i,g)):(r.nodes.push(g),RTree.Rectangle.expand_rectangle(r,g))},d=function(e){for(var t,n,i=e.length-1,s=0,o=e.length-1,r=0,a=e.length-2;a>=0;a--){var h=e[a];h.x>e[s].x?s=a:h.x+h.w<e[i].x+e[i].w&&(i=a),h.y>e[r].y?r=a:h.y+h.h<e[o].y+e[o].h&&(o=a)}var c=Math.abs(e[i].x+e[i].w-e[s].x),d=Math.abs(e[o].y+e[o].h-e[r].y);return c>d?i>s?(t=e.splice(i,1)[0],n=e.splice(s,1)[0]):(n=e.splice(s,1)[0],t=e.splice(i,1)[0]):o>r?(t=e.splice(o,1)[0],n=e.splice(r,1)[0]):(n=e.splice(r,1)[0],t=e.splice(o,1)[0]),[{x:t.x,y:t.y,w:t.w,h:t.h,nodes:[t]},{x:n.x,y:n.y,w:n.w,h:n.h,nodes:[n]}]},u=function(e,t){return e.nodes=t.nodes,e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e},l=function(e,t,n,i){var s=[];if(!RTree.Rectangle.overlap_rectangle(e,i))return n;s.push(i.nodes);do for(var o=s.pop(),r=o.length-1;r>=0;r--){var a=o[r];RTree.Rectangle.overlap_rectangle(e,a)&&("nodes"in a?s.push(a.nodes):"leaf"in a&&(t?n.push(a):n.push(a.leaf)))}while(s.length>0);return n},f=function(e,t){var i;if(0==t.nodes.length)return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,void t.nodes.push(e);var o=a(e,t),r=e;do{if(i&&"nodes"in i&&0==i.nodes.length){var c=i;i=o.pop();for(var d=0;d<i.nodes.length;d++)if(i.nodes[d]===c||0==i.nodes[d].nodes.length){i.nodes.splice(d,1);break}}else i=o.pop();if("leaf"in r||"nodes"in r||s(r)){if(s(r)){for(var u=0;u<r.length;u++)RTree.Rectangle.expand_rectangle(i,r[u]);i.nodes=i.nodes.concat(r)}else RTree.Rectangle.expand_rectangle(i,r),i.nodes.push(r);if(i.nodes.length<=n)r={x:i.x,y:i.y,w:i.w,h:i.h};else{var l=h(i.nodes);r=l,o.length<1&&(i.nodes.push(l[0]),o.push(i),r=l[1])}}else RTree.Rectangle.expand_rectangle(i,r),r={x:i.x,y:i.y,w:i.w,h:i.h}}while(o.length>0)};this.get_tree=function(){return i},this.set_tree=function(e,t){return t||(t=i),u(t,e)},this.search=function(e,t,n){if(arguments.length<1)throw"Wrong number of arguments. RT.Search requires at least a bounding rectangle.";switch(arguments.length){case 1:arguments[1]=!1;case 2:arguments[2]=[];case 3:arguments[3]=i;default:arguments.length=4}return l.apply(this,arguments)},this.toJSON=function(e,t){var n=[],s=[],r={},a=3,h=1,c="";if(e&&!RTree.Rectangle.overlap_rectangle(e,i))return"";t?(a+=4,s.push(t.nodes.length),n.push(t.nodes),c+="var main_tree = {x:"+t.x.toFixed()+",y:"+t.y.toFixed()+",w:"+t.w.toFixed()+",h:"+t.h.toFixed()+",nodes:["):(s.push(i.nodes.length),n.push(i.nodes),c+="var main_tree = {x:"+i.x.toFixed()+",y:"+i.y.toFixed()+",w:"+i.w.toFixed()+",h:"+i.h.toFixed()+",nodes:[");do{var d=n.pop(),u=s.pop()-1;for(u>=0&&u<d.length-1&&(c+=",");u>=0;){var l=d[u];if(!e||RTree.Rectangle.overlap_rectangle(e,l))if(l.nodes)if(h>=a){var f=(r.length,o("saved_subtree"));c+="{x:"+l.x.toFixed()+",y:"+l.y.toFixed()+",w:"+l.w.toFixed()+",h:"+l.h.toFixed()+",load:'"+f+".js'}",r[f]=this.toJSON(e,l),u>0&&(c+=",")}else c+="{x:"+l.x.toFixed()+",y:"+l.y.toFixed()+",w:"+l.w.toFixed()+",h:"+l.h.toFixed()+",nodes:[",h+=1,s.push(u),n.push(d),d=l.nodes,u=l.nodes.length;else if(l.leaf){var x=l.leaf.toJSON?l.leaf.toJSON():JSON.stringify(l.leaf);c+="{x:"+l.x.toFixed()+",y:"+l.y.toFixed()+",w:"+l.w.toFixed()+",h:"+l.h.toFixed()+",leaf:"+x+"}",u>0&&(c+=",")}else l.load&&(c+="{x:"+l.x.toFixed()+",y:"+l.y.toFixed()+",w:"+l.w.toFixed()+",h:"+l.h.toFixed()+",load:'"+l.load+"'}",u>0&&(c+=","));u-=1}0>u&&(c+="]}",h-=1)}while(n.length>0);c+=";";for(var g in r)c+="\nvar "+g+" = function(){"+r[g]+" return(main_tree);};";return c},this.remove=function(e,t){if(arguments.length<1)throw"Wrong number of arguments. RT.remove requires at least a bounding rectangle.";switch(arguments.length){case 1:arguments[1]=!1;case 2:arguments[2]=i;default:arguments.length=3}if(arguments[1]===!1){var n=0,s=[];do n=s.length,s=s.concat(r.apply(this,arguments));while(n!=s.length);return s}return r.apply(this,arguments)},this.insert=function(e,t){if(arguments.length<2)throw"Wrong number of arguments. RT.Insert requires at least a bounding rectangle and an object.";return f({x:e.x,y:e.y,w:e.w,h:e.h,leaf:t},i)}};RTree.Rectangle=function(e,t,n,i){var s,o,r,a,h,c;e.x?(s=e.x,r=e.y,0!==e.w&&!e.w&&e.x2?(h=e.x2-e.x,c=e.y2-e.y):(h=e.w,c=e.h),o=s+h,a=r+c):(s=e,r=t,h=n,c=i,o=s+h,a=r+c),this.x1=this.x=function(){return s},this.y1=this.y=function(){return r},this.x2=function(){return o},this.y2=function(){return a},this.w=function(){return h},this.h=function(){return c},this.toJSON=function(){return'{"x":'+s.toString()+', "y":'+r.toString()+', "w":'+h.toString()+', "h":'+c.toString()+"}"},this.overlap=function(e){return this.x()<e.x2()&&this.x2()>e.x()&&this.y()<e.y2()&&this.y2()>e.y()},this.expand=function(e){var t=Math.min(this.x(),e.x()),n=Math.min(this.y(),e.y());return h=Math.max(this.x2(),e.x2())-t,c=Math.max(this.y2(),e.y2())-n,s=t,r=n,this},this.setRect=function(e,t,n,i){var s,o,r,a,h,c;e.x?(s=e.x,r=e.y,0!==e.w&&!e.w&&e.x2?(h=e.x2-e.x,c=e.y2-e.y):(h=e.w,c=e.h),o=s+h,a=r+c):(s=e,r=t,h=n,c=i,o=s+h,a=r+c)}},RTree.Rectangle.overlap_rectangle=function(e,t){return e.x<t.x+t.w&&e.x+e.w>t.x&&e.y<t.y+t.h&&e.y+e.h>t.y},RTree.Rectangle.contains_rectangle=function(e,t){return e.x+e.w<=t.x+t.w&&e.x>=t.x&&e.y+e.h<=t.y+t.h&&e.y>=t.y},RTree.Rectangle.expand_rectangle=function(e,t){var n=Math.min(e.x,t.x),i=Math.min(e.y,t.y);return e.w=Math.max(e.x+e.w,t.x+t.w)-n,e.h=Math.max(e.y+e.h,t.y+t.h)-i,e.x=n,e.y=i,e},RTree.Rectangle.make_MBR=function(e,t){if(e.length<1)return{x:0,y:0,w:0,h:0};t?t.x=e[0].x:t={x:e[0].x,y:e[0].y,w:e[0].w,h:e[0].h},t.y=e[0].y,t.w=e[0].w,t.h=e[0].h;for(var n=e.length-1;n>0;n--)RTree.Rectangle.expand_rectangle(t,e[n]);return t};